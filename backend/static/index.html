<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ä°nsan Ekspertizi | Yapay Zeka Destekli Analiz</title>
    <style>
        :root {
            --primary: #4a00e0;
            --secondary: #8e2de2;
            --bg: #f5f7fa;
            --text: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text); }
        
        /* ÃœST MENÃœ */
        nav { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); text-decoration: none; }
        
        .auth-buttons button { margin-left: 10px; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-login { background: transparent; border: 2px solid var(--primary) !important; color: var(--primary); }
        .btn-register { background: var(--primary); color: white; }
        .btn-history { background: #ff9f43; color: white; }
        .btn-logout { background: #ff4757; color: white; }
        .btn-register:hover, .btn-history:hover, .btn-logout:hover { opacity: 0.9; transform: translateY(-2px); }
        
        .container { max-width: 800px; margin: 40px auto; padding: 20px; }
        
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px; transition: transform 0.3s; }
        .card:hover { transform: translateY(-5px); }
        h2 { color: var(--primary); margin-top: 0; }
        
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 5px rgba(74, 0, 224, 0.2); }
        
        button.action-btn { width: 100%; padding: 12px; background: linear-gradient(to right, var(--primary), var(--secondary)); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: 0.3s; font-weight: bold; }
        button.action-btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .result-box { margin-top: 20px; padding: 20px; background: #eef2f5; border-left: 5px solid var(--primary); border-radius: 5px; white-space: pre-wrap; display: none; line-height: 1.6; }

        /* MODAL (PENCERELER) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem; color: #aaa; }
        .close:hover { color: #333; }

        /* GEÃ‡MÄ°Å LÄ°STESÄ° STÄ°LÄ° */
        .history-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .history-item:last-child { border-bottom: none; }
        .history-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: white; margin-bottom: 5px; }
        .badge-ISIM { background: #0984e3; }
        .badge-RUYA { background: #6c5ce7; }
        .history-date { font-size: 0.8rem; color: #888; float: right; }
        .history-input { font-weight: bold; color: #2d3436; display: block; margin-bottom: 5px; }
        .history-result { 
    font-size: 0.9rem; 
    color: #636e72; 
    display: -webkit-box; 
    -webkit-line-clamp: 3; /* Eski tarayÄ±cÄ±lar iÃ§in */
    line-clamp: 3;         /* <--- YENÄ° EKLENECEK SATIR (Standart) */
    -webkit-box-orient: vertical; 
    overflow: hidden; 
}
    </style>
</head>
<body>

    <nav>
        <a href="#" class="logo">ğŸ§¬ Ä°nsan Ekspertizi</a>
        
        <div class="auth-buttons" id="guest-menu">
            <button class="btn-login" onclick="openModal('loginModal')">GiriÅŸ Yap</button>
            <button class="btn-register" onclick="openModal('registerModal')">KayÄ±t Ol</button>
        </div>

        <div class="auth-buttons" id="user-menu" style="display: none;">
            <span id="user-email-display" style="margin-right: 10px; font-weight: bold; display:none;"></span>
            <button class="btn-history" onclick="openHistory()">ğŸ“œ GeÃ§miÅŸim</button>
            <button class="btn-logout" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </nav>

    <div class="container">
        
        <div class="card">
            <h2>ğŸ“œ Ä°sim & Karakter Analizi</h2>
            <p>Ä°sminizin enerjisini ve gizli ÅŸifrelerini Ã§Ã¶zÃ¼n.</p>
            <input type="text" id="isim" placeholder="AdÄ±nÄ±z (Ã–rn: Ahmet)">
            <input type="text" id="soyisim" placeholder="SoyadÄ±nÄ±z (Ã–rn: YÄ±lmaz)">
            <button class="action-btn" onclick="isimAnaliziYap()">Analiz Et</button>
            <div id="isimSonuc" class="result-box"></div>
        </div>

        <div class="card">
            <h2>ğŸŒ™ RÃ¼ya Tabirleri</h2>
            <p>RÃ¼yanÄ±zÄ± anlatÄ±n, bilinÃ§altÄ± mesajÄ±nÄ±zÄ± yapay zeka yorumlasÄ±n.</p>
            <textarea id="ruyaMetni" rows="4" placeholder="RÃ¼yamda uÃ§uyordum ve..."></textarea>
            <button class="action-btn" onclick="ruyaAnaliziYap()">RÃ¼yayÄ± Yorumla</button>
            <div id="ruyaSonuc" class="result-box"></div>
        </div>

    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2>GiriÅŸ Yap</h2>
            <input type="email" id="loginEmail" placeholder="E-posta Adresiniz">
            <input type="password" id="loginPass" placeholder="Åifreniz">
            <button class="action-btn" onclick="login()">GiriÅŸ Yap</button>
        </div>
    </div>

    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2>KayÄ±t Ol</h2>
            <input type="email" id="regEmail" placeholder="E-posta Adresiniz">
            <input type="password" id="regPass" placeholder="Åifre Belirleyin">
            <button class="action-btn" onclick="register()">Ãœcretsiz KayÄ±t Ol</button>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('historyModal')">&times;</span>
            <h2>ğŸ“œ GeÃ§miÅŸ Analizlerim</h2>
            <div id="historyList">
                <p>YÃ¼kleniyor...</p>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = "/api"; 
        
        // --- AUTH KONTROLÃœ ---
        function checkAuth() {
            const token = localStorage.getItem("token");
            const email = localStorage.getItem("email");
            
            if (token && email) {
                document.getElementById("guest-menu").style.display = "none";
                document.getElementById("user-menu").style.display = "block";
                document.getElementById("user-email-display").innerText = email;
            } else {
                document.getElementById("guest-menu").style.display = "block";
                document.getElementById("user-menu").style.display = "none";
            }
        }

        // --- AUTH Ä°ÅLEMLERÄ° ---
        async function register() {
            const email = document.getElementById("regEmail").value;
            const password = document.getElementById("regPass").value;

            try {
                const res = await fetch(`${BASE_URL}/register`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });
                
                if (res.ok) {
                    alert("KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapabilirsiniz.");
                    closeModal("registerModal");
                    openModal("loginModal");
                } else {
                    const data = await res.json();
                    alert("Hata: " + (data.detail || "Bilinmeyen hata"));
                }
            } catch (e) { alert("Sunucu hatasÄ±! LÃ¼tfen sayfayÄ± yenileyip tekrar deneyin."); }
        }

        async function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPass").value;
            
            const formData = new URLSearchParams();
            formData.append("username", email);
            formData.append("password", password);

            try {
                const res = await fetch(`${BASE_URL}/token`, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    localStorage.setItem("token", data.access_token);
                    localStorage.setItem("email", email);
                    checkAuth();
                    closeModal("loginModal");
                } else {
                    alert("HatalÄ± e-posta veya ÅŸifre!");
                }
            } catch (e) { alert("BaÄŸlantÄ± hatasÄ±!"); }
        }

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("email");
            location.reload();
        }

        // --- GEÃ‡MÄ°ÅÄ° GETÄ°R (YENÄ° Ã–ZELLÄ°K) ---
        async function openHistory() {
            openModal('historyModal');
            const listDiv = document.getElementById("historyList");
            const token = localStorage.getItem("token");
            
            if (!token) {
                listDiv.innerHTML = "<p>LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n.</p>";
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/users/me`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    // data.analyses listesini tersten sÄ±rala (en yeni en Ã¼stte)
                    const analyses = data.analyses.reverse();

                    if (analyses.length === 0) {
                        listDiv.innerHTML = "<p>HenÃ¼z hiÃ§ analiz yapmamÄ±ÅŸsÄ±nÄ±z.</p>";
                        return;
                    }

                    let html = "";
                    analyses.forEach(item => {
                        const tarih = new Date(item.created_at).toLocaleDateString("tr-TR");
                        const tipBadge = item.analysis_type === "ISIM" ? "badge-ISIM" : "badge-RUYA";
                        const tipText = item.analysis_type === "ISIM" ? "Ä°sim Analizi" : "RÃ¼ya Tabiri";
                        
                        html += `
                            <div class="history-item">
                                <span class="history-badge ${tipBadge}">${tipText}</span>
                                <span class="history-date">${tarih}</span>
                                <span class="history-input">"${item.input_text}"</span>
                                <div class="history-result">${item.result_text.substring(0, 150)}...</div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = "<p>GeÃ§miÅŸ yÃ¼klenemedi. Oturum sÃ¼reniz dolmuÅŸ olabilir.</p>";
                }
            } catch (e) {
                listDiv.innerHTML = "<p>BaÄŸlantÄ± hatasÄ±!</p>";
            }
        }

        // --- ANALÄ°Z FONKSÄ°YONLARI ---
        async function requestAnalysis(url, formData, resultId) {
            const sonucDiv = document.getElementById(resultId);
            sonucDiv.style.display = "block";
            sonucDiv.innerHTML = "â³ Yapay zeka analiz yapÄ±yor, lÃ¼tfen bekleyin...";

            // EÄŸer giriÅŸ yapmÄ±ÅŸsa Token'Ä± ekle (KayÄ±t iÃ§in)
            const token = localStorage.getItem("token");
            const headers = {};
            if (token) {
                headers["Authorization"] = `Bearer ${token}`;
            }

            try {
                const res = await fetch(BASE_URL + url, {
                    method: "POST",
                    headers: headers, // Token'Ä± header'a ekledik ama FormData olduÄŸu iÃ§in Content-Type eklemiyoruz (Otomatik eklenir)
                    body: formData
                });
                const data = await res.json();
                
                if (data.analiz_sonucu) {
                    sonucDiv.innerHTML = data.analiz_sonucu; // Ä°sim analizi cevabÄ±
                } else if (data.analiz) {
                    sonucDiv.innerHTML = data.analiz; // RÃ¼ya analizi cevabÄ±
                } else {
                    sonucDiv.innerText = "Bir hata oluÅŸtu: " + JSON.stringify(data);
                }
            } catch (e) {
                sonucDiv.innerText = "Sunucuya baÄŸlanÄ±lamadÄ±.";
            }
        }

        function isimAnaliziYap() {
            const isim = document.getElementById("isim").value;
            const soyisim = document.getElementById("soyisim").value;
            if(!isim) { alert("LÃ¼tfen isim girin."); return; }
            
            const formData = new FormData();
            formData.append("isim", isim);
            formData.append("soyisim", soyisim);
            requestAnalysis("/isim-analizi-yap", formData, "isimSonuc");
        }

        function ruyaAnaliziYap() {
            const metin = document.getElementById("ruyaMetni").value;
            if(metin.length < 5) { alert("LÃ¼tfen rÃ¼yanÄ±zÄ± anlatÄ±n."); return; }
            
            const formData = new FormData();
            formData.append("ruya_metni", metin);
            requestAnalysis("/ruya-analizi", formData, "ruyaSonuc");
        }

        // --- MODAL FONKSÄ°YONLARI ---
        function openModal(id) { document.getElementById(id).style.display = "flex"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
        
        checkAuth();
    </script>
</body>
</html>