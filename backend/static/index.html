<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İnsan Ekspertizi | Premium Analiz</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9626/9626780.png">
    <meta name="theme-color" content="#6c5ce7">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #6c5ce7; --dark: #2d3436; --bg-light: #f8f9fd; --white: #ffffff; --glass: rgba(255, 255, 255, 0.95); --radius: 20px; --transition: all 0.3s ease; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); margin: 0; color: var(--dark); overflow-x: hidden; line-height: 1.6; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-thumb { background: #b2bec3; border-radius: 4px; }

        /* NAV */
        nav { background: var(--glass); backdrop-filter: blur(15px); padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); text-decoration: none; }
        .nav-actions { display: flex; gap: 10px; }
        .btn-base { padding: 8px 20px; border-radius: 50px; font-weight: 600; cursor: pointer; border: none; font-size: 0.9rem; transition: var(--transition); }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: none; }
        .btn-fill { background: var(--primary); color: white; } .btn-fill:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); }

        /* HERO */
        .hero { text-align: center; padding: 80px 20px 60px; }
        .hero h1 { font-size: 3rem; margin-bottom: 20px; line-height: 1.2; }
        .hero span { color: var(--primary); }

        /* ARAÇLAR */
        .tools-grid { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; padding: 20px; }
        .tool-card { background: white; padding: 40px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: var(--transition); border: 1px solid #fff; position: relative; overflow: hidden; }
        .tool-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        
        /* MENTOR SEÇİMİ (YENİ) */
        .mentor-select-wrapper { margin-bottom: 20px; }
        .mentor-options { display: flex; gap: 10px; margin-top: 10px; }
        .m-option { flex: 1; padding: 10px; border: 1px solid #eee; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.2s; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .m-option i { font-size: 1.2rem; margin-bottom: 5px; }
        .m-option:hover { background: #f8f9fa; }
        
        /* Radio Input Gizleme */
        .m-option input { display: none; }
        .m-option.selected { border-color: var(--primary); background: #f0eeff; color: var(--primary); font-weight: bold; }

        /* FORM */
        input[type="text"], textarea { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px; font-family: inherit; box-sizing: border-box; transition: 0.3s; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); }
        .submit-btn { width: 100%; padding: 16px; background: var(--dark); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .submit-btn:hover { background: var(--primary); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 500px; padding: 40px; border-radius: 20px; position: relative; animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .close-modal { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5rem; color: #999; }

        /* GEÇMİŞ LİSTESİ */
        .history-list { max-height: 400px; overflow-y: auto; text-align: left; }
        .h-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .h-info { flex: 1; }
        .h-status { font-size: 0.8rem; font-weight: bold; padding: 4px 8px; border-radius: 6px; }
        .status-wait { background: #fff3cd; color: #856404; }
        .status-ready { background: #d4edda; color: #155724; }
        .h-btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 10px; }
        .btn-view { background: var(--primary); color: white; }

        /* DAKTİLO EFEKTİ İÇİN */
        .typewriter-text { text-align: left; white-space: pre-wrap; line-height: 1.8; font-size: 1.05rem; color: #444; max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .cursor { display: inline-block; width: 2px; height: 1.2em; background: var(--primary); animation: blink 1s infinite; vertical-align: bottom; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* AUTH FORMS */
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; }

        @media (max-width: 768px) { .nav-actions { display: none; } }
    </style>
</head>
<body>

    <nav>
        <a href="/" class="logo"><i class="fa-solid fa-dna"></i> İnsan Ekspertizi</a>
        <div class="nav-actions" id="guest-nav">
            <button class="btn-base btn-outline" onclick="openModal('loginModal')">Giriş</button>
            <button class="btn-base btn-fill" onclick="openModal('registerModal')">Kayıt Ol</button>
        </div>
        <div class="nav-actions" id="user-nav" style="display: none;">
            <button class="btn-base btn-outline" onclick="openHistory()"><i class="fa-solid fa-clock-rotate-left"></i> Analizlerim</button>
            <button class="btn-base btn-fill" onclick="logout()">Çıkış</button>
        </div>
    </nav>

    <div id="main-content">
        <section id="guest-hero" class="hero">
            <h1>Gerçek Uzmanlardan <br> <span>Profesyonel Analiz</span></h1>
            <p>Seçtiğiniz uzman (Yahya Bey, Aslı Hanım veya Dr. Mustafa) verilerinizi inceler ve size özel raporu 10 dakika içinde hazırlar.</p>
            <button class="submit-btn" onclick="openModal('registerModal')" style="width:auto; margin:30px auto; padding: 15px 40px;">
                Hemen Başla
            </button>
        </section>

        <section id="member-tools" class="tools-grid" style="display: none;">
            
            <div class="tool-card">
                <h3><i class="fa-solid fa-fingerprint"></i> İsim Karakter Analizi</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">Kimin analiz etmesini istersiniz?</p>
                
                <div class="mentor-select-wrapper">
                    <div class="mentor-options" id="isim-mentor-select">
                        <div class="m-option selected" onclick="selectOption(this, 'isim_mentor', 'yahya')">
                            <i class="fa-solid fa-book-quran"></i> Yahya Bey
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'isim_mentor', 'asli')">
                            <i class="fa-solid fa-star"></i> Aslı Hanım
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'isim_mentor', 'mustafa')">
                            <i class="fa-solid fa-brain"></i> Dr. Mustafa
                        </div>
                    </div>
                    <input type="hidden" id="isim_mentor" value="yahya">
                </div>

                <input type="text" id="isim" placeholder="Adınız">
                <input type="text" id="soyisim" placeholder="Soyadınız">
                <button class="submit-btn" onclick="submitRequest('isim')">
                    <i class="fa-solid fa-paper-plane"></i> İncelemeye Gönder
                </button>
            </div>

            <div class="tool-card">
                <h3><i class="fa-solid fa-moon"></i> Rüya Yorumu</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">Kimin yorumlamasını istersiniz?</p>
                
                <div class="mentor-select-wrapper">
                    <div class="mentor-options" id="ruya-mentor-select">
                        <div class="m-option selected" onclick="selectOption(this, 'ruya_mentor', 'yahya')">
                            <i class="fa-solid fa-book-quran"></i> Yahya Bey
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'ruya_mentor', 'asli')">
                            <i class="fa-solid fa-star"></i> Aslı Hanım
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'ruya_mentor', 'mustafa')">
                            <i class="fa-solid fa-brain"></i> Dr. Mustafa
                        </div>
                    </div>
                    <input type="hidden" id="ruya_mentor" value="yahya">
                </div>

                <textarea id="ruya-metni" rows="4" placeholder="Rüyanızı detaylı anlatın..."></textarea>
                <button class="submit-btn" onclick="submitRequest('ruya')">
                    <i class="fa-solid fa-paper-plane"></i> İncelemeye Gönder
                </button>
            </div>
        </section>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:4rem; color:#00b894; margin-bottom:20px;"><i class="fa-regular fa-circle-check"></i></div>
            <h2>Talep İletildi!</h2>
            <p id="successMsg" style="color:#666; margin-bottom:20px;">Uzmanımız şu an dosyanızı inceliyor. Detaylı analiz yaklaşık 10-15 dakika sürecektir.</p>
            <p style="font-size:0.9rem; background:#f8f9fa; padding:10px; border-radius:10px;">
                <i class="fa-solid fa-bell"></i> Analiz tamamlandığında "Analizlerim" kısmından görüntüleyebilirsiniz.
            </p>
            <button class="submit-btn" onclick="closeModal('successModal')" style="margin-top:20px;">Tamam</button>
        </div>
    </div>

    <div id="resultModal" class="modal-overlay">
        <div class="modal-box" style="max-width:700px; text-align:left;">
            <span class="close-modal" onclick="closeModal('resultModal')">&times;</span>
            <h3 id="resultTitle" style="color:var(--primary); margin-top:0;">Analiz Raporu</h3>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            
            <div id="typewriterArea" class="typewriter-text"></div>
            
            <div style="margin-top:20px; text-align:right;">
                <button class="btn-base btn-outline" onclick="copyResult()"><i class="fa-regular fa-copy"></i> Kopyala</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-box" style="max-width:600px; padding:0; overflow:hidden;">
            <div style="padding:20px; background:#f8f9fa; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Analizlerim</h3>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="closeModal('historyModal')">&times;</span>
            </div>
            <div id="historyList" class="history-list">
                </div>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Giriş Yap</h2>
            <input type="email" id="loginEmail" class="auth-input" placeholder="E-posta">
            <input type="password" id="loginPass" class="auth-input" placeholder="Şifre">
            <button class="submit-btn" onclick="login()">Giriş Yap</button>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Kayıt Ol</h2>
            <input type="email" id="regEmail" class="auth-input" placeholder="E-posta">
            <input type="password" id="regPass" class="auth-input" placeholder="Şifre">
            <button class="submit-btn" onclick="register()">Kayıt Ol</button>
        </div>
    </div>

    <script>
        // --- SEÇİM MANTIĞI ---
        function selectOption(el, inputId, value) {
            // Görseli güncelle
            const container = el.parentElement;
            container.querySelectorAll('.m-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            // Değeri kaydet
            document.getElementById(inputId).value = value;
        }

        // --- İSTEK GÖNDERME (BEKLETME MANTIĞI) ---
        async function submitRequest(type) {
            const token = localStorage.getItem("token");
            if(!token) return openModal('loginModal');

            let fd = new FormData();
            let mentorName = "";

            if(type === 'isim') {
                const isim = document.getElementById('isim').value;
                const soyisim = document.getElementById('soyisim').value;
                const mentor = document.getElementById('isim_mentor').value;
                if(!isim) return alert("İsim giriniz");
                fd.append("isim", isim);
                fd.append("soyisim", soyisim);
                fd.append("mentor", mentor);
                mentorName = mentor === 'yahya' ? "Yahya Bey" : (mentor === 'asli' ? "Aslı Hanım" : "Dr. Mustafa");
                
                // API Çağrısı (Arka planda çalışsın, cevabı beklemeden modala geçebiliriz ama garanti olsun diye bekliyoruz)
                await fetch("/api/isim-analizi-yap", {method:"POST", headers:{"Authorization":`Bearer ${token}`}, body:fd});
            
            } else {
                const ruya = document.getElementById('ruya-metni').value;
                const mentor = document.getElementById('ruya_mentor').value;
                if(!ruya) return alert("Rüya giriniz");
                fd.append("ruya_metni", ruya);
                fd.append("mentor", mentor);
                mentorName = mentor === 'yahya' ? "Yahya Bey" : (mentor === 'asli' ? "Aslı Hanım" : "Dr. Mustafa");
                
                await fetch("/api/ruya-analizi", {method:"POST", headers:{"Authorization":`Bearer ${token}`}, body:fd});
            }

            // Başarı mesajını göster
            document.getElementById("successMsg").innerText = `${mentorName} talebinizi aldı. Dosyanız sıraya alındı ve inceleniyor. 10 dakika sonra sonucunuz hazır olacak.`;
            openModal('successModal');
            
            // Formları temizle
            if(document.getElementById('isim')) document.getElementById('isim').value = "";
            if(document.getElementById('ruya-metni')) document.getElementById('ruya-metni').value = "";
        }

        // --- GEÇMİŞ VE DURUM KONTROLÜ ---
        async function openHistory() {
            openModal('historyModal');
            const list = document.getElementById('historyList');
            list.innerHTML = '<p style="padding:20px; text-align:center;">Yükleniyor...</p>';
            
            try {
                const res = await fetch("/api/users/me", {headers:{"Authorization":`Bearer ${localStorage.getItem("token")}`}});
                const user = await res.json();
                
                if(!user.analyses || user.analyses.length === 0) {
                    list.innerHTML = '<p style="padding:20px; text-align:center;">Henüz analiz yok.</p>';
                    return;
                }

                list.innerHTML = "";
                // En yeni en üstte
                user.analyses.slice().reverse().forEach(a => {
                    // Backend'den gelen "WAITING" kontrolü
                    const isWaiting = a.result_text === "WAITING_FOR_MENTOR";
                    
                    let statusHtml = "";
                    let btnHtml = "";

                    if(isWaiting) {
                        statusHtml = `<span class="h-status status-wait"><i class="fa-solid fa-hourglass-half"></i> İnceleniyor (10dk)</span>`;
                        btnHtml = `<button class="h-btn" disabled style="opacity:0.5; cursor:not-allowed;">Bekleyin</button>`;
                    } else {
                        statusHtml = `<span class="h-status status-ready"><i class="fa-solid fa-check"></i> Hazır</span>`;
                        // Tam metni güvenli şekilde gönder
                        const safeText = encodeURIComponent(a.result_text);
                        btnHtml = `<button class="h-btn btn-view" onclick="showResult('${safeText}')">Sonucu Oku</button>`;
                    }

                    list.innerHTML += `
                        <div class="h-item">
                            <div class="h-info">
                                <div style="font-weight:bold;">${a.input_text.substring(0,25)}...</div>
                                <div style="font-size:0.8rem; color:#888;">${new Date(a.created_at).toLocaleTimeString().substring(0,5)}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="margin-bottom:5px;">${statusHtml}</div>
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                });

            } catch(e) { list.innerHTML = "Hata"; }
        }

        // --- DAKTİLO EFEKTİ ---
        let typeInterval;
        function showResult(encodedText) {
            closeModal('historyModal');
            openModal('resultModal');
            
            const text = decodeURIComponent(encodedText);
            const container = document.getElementById('typewriterArea');
            container.innerHTML = ""; // Temizle
            
            let i = 0;
            clearInterval(typeInterval); // Önceki varsa durdur

            // Efekt Başlasın
            typeInterval = setInterval(() => {
                container.innerHTML += text.charAt(i);
                container.scrollTop = container.scrollHeight; // Otomatik aşağı kaydır
                i++;
                if (i > text.length) {
                    clearInterval(typeInterval);
                    // İmleci kaldır veya yanıp söndür
                }
            }, 30); // Yazma hızı (ms)
        }
        
        function copyResult() {
            const text = document.getElementById('typewriterArea').innerText;
            navigator.clipboard.writeText(text);
            alert("Metin kopyalandı!");
        }

        // --- AUTH & GENEL ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; clearInterval(typeInterval); }
        
        // Auth Kontrol
        if(localStorage.getItem("token")) {
            document.getElementById("guest-nav").style.display = "none";
            document.getElementById("user-nav").style.display = "flex";
            document.getElementById("guest-hero").style.display = "none";
            document.getElementById("member-tools").style.display = "grid";
        }

        // Login/Register API Çağrıları (Standart)
        async function login() {
            const email = document.getElementById("loginEmail").value;
            const pass = document.getElementById("loginPass").value;
            let fd = new FormData(); fd.append("username", email); fd.append("password", pass);
            let res = await fetch("/api/token", {method:"POST", body:fd});
            if(res.ok) {
                let data = await res.json();
                localStorage.setItem("token", data.access_token);
                window.location.reload();
            } else alert("Hata");
        }
        async function register() {
            let email = document.getElementById("regEmail").value;
            let pass = document.getElementById("regPass").value;
            let res = await fetch("/api/register", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email, password:pass})});
            if(res.ok) { alert("Kayıt olundu!"); window.location.reload(); }
        }
        function logout() { localStorage.removeItem("token"); window.location.reload(); }
    </script>
</body>
</html>