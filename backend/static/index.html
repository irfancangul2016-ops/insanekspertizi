<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İnsan Ekspertizi | Premium Analiz</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9626/9626780.png">
    <meta name="theme-color" content="#6c5ce7">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @keyframes spin { 100% { -webkit-transform: rotate(360deg); transform:rotate(360deg); } }
        /* --- KOZMİK PREMIUM TEMA --- */
        :root { 
            --primary: #6c5ce7; 
            --accent: #a29bfe;
            --dark-bg: #0f0c29; 
            --card-bg: rgba(255, 255, 255, 0.05); /* Yarı saydam */
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #b2bec3;
            --radius: 24px; 
            --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            /* Derin Mor Uzay Gradyanı */
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            background-attachment: fixed; /* Arkaplan sabit kalsın */
            margin: 0; 
            color: var(--text-main); 
            overflow-x: hidden; 
            line-height: 1.6; 
            min-height: 100vh;
        }

        /* Scrollbar Güzelleştirme */
        ::-webkit-scrollbar { width: 10px; } 
        ::-webkit-scrollbar-track { background: #0f0c29; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 5px; }

        /* NAV (Cam Efekti) */
        nav { 
            background: rgba(15, 12, 41, 0.7); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            padding: 1.2rem 5%; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000; 
            border-bottom: 1px solid var(--glass-border); 
        }
        
        .nav-link { text-decoration: none; color: var(--text-muted); font-weight: 500; transition: 0.3s; }
        .nav-link:hover { color: var(--accent); text-shadow: 0 0 10px var(--primary); }

        /* BUTONLAR (Neon Efekti) */
        .btn-base { padding: 10px 25px; border-radius: 50px; font-weight: 600; cursor: pointer; border: none; font-size: 0.95rem; transition: var(--transition); letter-spacing: 0.5px; }
        .btn-outline { border: 1px solid var(--primary); color: var(--accent); background: transparent; }
        .btn-outline:hover { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary); }
        
        .btn-fill { 
            background: linear-gradient(45deg, var(--primary), #8e44ad); 
            color: white; 
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
        } 
        .btn-fill:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6); }

        /* HERO ALANI */
        .hero { text-align: center; padding: 100px 20px 60px; position: relative; }
        .hero h1 { 
            font-size: 3.5rem; 
            margin-bottom: 20px; 
            line-height: 1.2; 
            font-weight: 700; 
            
            /* Gradyan Metin Ayarları */
            background: linear-gradient(to right, #fff, #a29bfe); 
            -webkit-background-clip: text; /* Chrome, Safari için */
            background-clip: text;         /* Standart özellik (Hata çözen kısım) */
            -webkit-text-fill-color: transparent; 
        }
        .hero p { font-size: 1.1rem; color: var(--text-muted); max-width: 600px; margin: 0 auto 30px; }

        /* KARTLAR (Glassmorphism) */
        .tools-grid { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 40px; padding: 20px; }
        
        .tool-card { 
            background: var(--card-bg); 
            backdrop-filter: blur(15px);
            padding: 40px; 
            border-radius: var(--radius); 
            border: 1px solid var(--glass-border); 
            transition: var(--transition); 
            position: relative; overflow: hidden;
        }
        .tool-card:hover { 
            transform: translateY(-10px); 
            border-color: var(--primary); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            background: rgba(255,255,255,0.08);
        }
        .tool-card h3 { color: white; margin-top: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .tool-card h3 i { color: var(--accent); }

        /* MENTOR SEÇİMİ */
        .m-option { 
            flex: 1; padding: 15px; 
            border: 1px solid var(--glass-border); 
            border-radius: 16px; 
            cursor: pointer; text-align: center; transition: 0.3s; 
            background: rgba(0,0,0,0.2); color: var(--text-muted);
        }
        .m-option:hover { background: rgba(255,255,255,0.1); color: white; }
        .m-option.selected { 
            border-color: var(--primary); 
            background: rgba(108, 92, 231, 0.2); 
            color: var(--accent); 
            box-shadow: 0 0 15px rgba(108, 92, 231, 0.2);
        }

        /* INPUTLAR */
        input[type="text"], input[type="email"], input[type="password"], textarea { 
            width: 100%; padding: 16px; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--glass-border); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            color: white; font-family: inherit; box-sizing: border-box; transition: 0.3s; 
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); background: rgba(0,0,0,0.5); }
        
        .submit-btn { width: 100%; padding: 18px; background: white; color: var(--dark-bg); border: none; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .submit-btn:hover { background: var(--accent); box-shadow: 0 0 20px rgba(255,255,255,0.4); }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { 
            background: #1e1b4b; /* Koyu Modal */
            width: 90%; max-width: 500px; padding: 40px; border-radius: 24px; position: relative; 
            border: 1px solid var(--glass-border);
            color: white;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .close-modal { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 1.5rem; color: var(--text-muted); transition: 0.3s; }
        .close-modal:hover { color: white; transform: rotate(90deg); }

        /* GEÇMİŞ LİSTESİ */
        .history-list { max-height: 400px; overflow-y: auto; text-align: left; }
        .h-item { padding: 15px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; transition:0.2s; }
        .h-item:hover { background: rgba(255,255,255,0.05); }
        .h-status { font-size: 0.75rem; font-weight: bold; padding: 5px 10px; border-radius: 6px; }
        .status-ready { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid rgba(46, 204, 113, 0.3); }
        .h-btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 10px; background: var(--primary); color: white; }

        /* DAKTİLO ALANI */
        .typewriter-text { 
            text-align: left; white-space: pre-wrap; line-height: 1.8; font-size: 1rem; 
            color: #dfe6e9; 
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);
            max-height: 60vh; overflow-y: auto; 
        }

        @media (max-width: 768px) { .nav-actions { display: none; } .nav-center { display:none; } .hero h1 { font-size: 2.2rem; } }
        /* --- RENK DÜZELTME YAMASI --- */
        
        /* 1. Inputların içini zorla koyu yap, yazıyı beyaz yap */
        input, textarea, select {
            background-color: rgba(0, 0, 0, 0.4) !important; 
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }
        /* Tarayıcı otomatik doldurma yapınca arka planı sarı/beyaz yapmasın */
        input:-webkit-autofill,
        input:-webkit-autofill:hover, 
        input:-webkit-autofill:focus {
            -webkit-text-fill-color: #ffffff;
            -webkit-box-shadow: 0 0 0px 1000px #24243e inset;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* 2. Modalların (Giriş/Sonuç Ekranı) arka planını netleştir */
        .modal-box {
            background-color: #1e1b4b !important; /* Çok koyu lacivert */
            color: #ffffff !important;
            border: 1px solid #6c5ce7;
        }
        
        /* 3. Mentor seçim kutularındaki yazılar okunmuyorsa */
        .m-option {
            background-color: rgba(255, 255, 255, 0.05);
            color: #b2bec3;
        }
        .m-option.selected {
            background-color: rgba(108, 92, 231, 0.3);
            color: #ffffff;
            font-weight: bold;
        }
        /* --- ACİL DÜZELTME YAMASI (EN ALTA EKLE) --- */

        /* 1. MODAL KUTULARINI TAMAMEN KOYU YAP */
        .modal-box, #resultModal .modal-box, #historyModal .modal-box {
            background-color: #1e1b4b !important; /* Koyu Lacivert */
            background: #1e1b4b !important;       /* Gradyan varsa ez */
            color: #ffffff !important;            /* Yazılar Beyaz */
            border: 1px solid #6c5ce7 !important; /* Çerçeve Mor */
            box-shadow: 0 0 40px rgba(0,0,0,0.7) !important;
        }

        /* 2. MODAL BAŞLIKLARINI DÜZELT */
        .modal-box h2, .modal-box h3, #resultTitle {
            color: #a29bfe !important; /* Başlıklar Açık Mor */
            background: transparent !important; /* Arkası beyaz kalmasın */
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        /* 3. KURTARICI ÇARPI (X) BUTONU */
        .close-modal {
            position: absolute !important;
            top: 15px !important;
            right: 15px !important;
            
            /* Görünürlük Ayarları */
            background-color: #ff4757 !important; /* KIRMIZI */
            color: #ffffff !important;            /* BEYAZ X */
            
            width: 36px !important;
            height: 36px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 20px !important;
            z-index: 9999 !important; /* En üstte dur */
            cursor: pointer !important;
            opacity: 1 !important; /* Şeffaflığı kaldır */
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.6) !important;
        }
        .close-modal:hover {
            background-color: #ff6b81 !important;
            transform: rotate(90deg);
        }

        /* 4. INPUT ALANLARINI BELİRGİNLEŞTİR */
        input, textarea, select {
            background-color: rgba(255, 255, 255, 0.07) !important; /* Hafif şeffaf */
            color: #ffffff !important;
            border: 1px solid rgba(162, 155, 254, 0.3) !important; /* İnce mor çerçeve */
        }
        input:focus, textarea:focus {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: #6c5ce7 !important;
            box-shadow: 0 0 15px rgba(108, 92, 231, 0.2) !important;
        }

        /* 5. SEÇİM RENGİNİ DÜZELT (O Mavi Arkaplanı Kaldır) */
        ::selection {
            background: #6c5ce7;
            color: white;
        }
    </style>
</head>
<body>
    <audio id="bgMusic" loop>
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
    </audio>

    <div id="musicControl" onclick="toggleMusic()" style="position:fixed; bottom:20px; right:20px; z-index:1000; background:rgba(255,255,255,0.1); backdrop-filter:blur(5px); padding:10px; border-radius:50%; cursor:pointer; border:1px solid rgba(255,255,255,0.2); transition:0.3s;">
        <i id="musicIcon" class="fa-solid fa-volume-xmark" style="color:white; font-size:1.2rem; width:20px; text-align:center;"></i>
    </div>
    <nav>
        <a href="/" class="logo">
            <i class="fa-solid fa-moon" style="font-size:1.8rem; color:#a29bfe;"></i> 
            <span style="background: linear-gradient(to right, #fff, #a29bfe); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">İnsan Ekspertizi</span>
        </a>
        
        <div class="nav-center">
            <a href="/blog" class="nav-link"><i class="fa-solid fa-feather"></i> Blog & Makaleler</a>
        </div>

        <div class="nav-actions" id="guest-nav">
            <button class="btn-base btn-outline" onclick="openModal('loginModal')">Giriş</button>
            <button class="btn-base btn-fill" onclick="openModal('registerModal')">Kayıt Ol</button>
        </div>
        <div class="nav-actions" id="user-nav" style="display: none;">
            <button class="btn-base btn-outline" onclick="openHistory()"><i class="fa-solid fa-clock-rotate-left"></i> Analizlerim</button>
            <button class="btn-base btn-fill" onclick="logout()">Çıkış</button>
        </div>
    </nav>

    <div id="main-content">
        <section id="guest-hero" class="hero">
            <h1>Gerçek Uzmanlardan <br> <span>Profesyonel Analiz</span></h1>
            <p>Seçtiğiniz uzman (Yahya Bey, Aslı Hanım veya Dr. Mustafa) verilerinizi inceler ve size özel raporu 10 dakika içinde hazırlar.</p>
            
            <div style="display:flex; gap:10px; justify-content:center; margin-top:30px;">
                <button class="submit-btn" onclick="openModal('registerModal')" style="width:auto; padding: 15px 40px;">
                    Hemen Başla
                </button>
                <a href="/blog" class="submit-btn" style="width:auto; padding: 15px 40px; background:rgb(76, 0, 255); color:var(--dark); border:1px solid #ddd; text-decoration:none;">
                    Blog'a Göz At
                </a>
            </div>
        </section>

        <section id="member-tools" class="tools-grid" style="display: none;">
            
            <div class="tool-card">
                <h3><i class="fa-solid fa-fingerprint"></i> İsim Karakter Analizi</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">Kimin analiz etmesini istersiniz?</p>
                
                <div class="mentor-select-wrapper">
                    <div class="mentor-options" id="isim-mentor-select">
                        <div class="m-option selected" onclick="selectOption(this, 'isim_mentor', 'yahya')">
                            <i class="fa-solid fa-book-quran"></i> Yahya Bey
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'isim_mentor', 'asli')">
                            <i class="fa-solid fa-star"></i> Aslı Hanım
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'isim_mentor', 'mustafa')">
                            <i class="fa-solid fa-brain"></i> Dr. Mustafa
                        </div>
                    </div>
                    <input type="hidden" id="isim_mentor" value="yahya">
                </div>

                <input type="text" id="isim" placeholder="Adınız">
                <input type="text" id="soyisim" placeholder="Soyadınız" autocomplete="off" name="user_surname_field">
                <button class="submit-btn" onclick="submitRequest('isim')">
                    <i class="fa-solid fa-paper-plane"></i> İncelemeye Gönder
                </button>
            </div>

            <div class="tool-card">
                <h3><i class="fa-solid fa-moon"></i> Rüya Yorumu</h3>
                <p style="font-size:0.9rem; color:#666; margin-bottom:20px;">Kimin yorumlamasını istersiniz?</p>
                
                <div class="mentor-select-wrapper">
                    <div class="mentor-options" id="ruya-mentor-select">
                        <div class="m-option selected" onclick="selectOption(this, 'ruya_mentor', 'yahya')">
                            <i class="fa-solid fa-book-quran"></i> Yahya Bey
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'ruya_mentor', 'asli')">
                            <i class="fa-solid fa-star"></i> Aslı Hanım
                        </div>
                        <div class="m-option" onclick="selectOption(this, 'ruya_mentor', 'mustafa')">
                            <i class="fa-solid fa-brain"></i> Dr. Mustafa
                        </div>
                    </div>
                    <input type="hidden" id="ruya_mentor" value="yahya">
                </div>

                <textarea id="ruya-metni" rows="4" placeholder="Rüyanızı detaylı anlatın..."></textarea>
                <button class="submit-btn" onclick="submitRequest('ruya')">
                    <i class="fa-solid fa-paper-plane"></i> İncelemeye Gönder
                </button>
            </div>
        </section>
    </div>

    <div id="successModal" class="modal-overlay">
        <div class="modal-box">
            <div style="font-size:4rem; color:#00b894; margin-bottom:20px;"><i class="fa-regular fa-circle-check"></i></div>
            <h2>Talep İletildi!</h2>
            <p id="successMsg" style="color:#666; margin-bottom:20px;"></p>
            <p style="font-size:0.9rem; background:#f8f9fa; padding:10px; border-radius:10px;">
                <i class="fa-solid fa-bell"></i> Analiz tamamlandığında "Analizlerim" kısmından görüntüleyebilirsiniz.
            </p>
            <button class="submit-btn" onclick="closeModal('successModal')" style="margin-top:20px;">Tamam</button>
        </div>
    </div>

    <div id="resultModal" class="modal-overlay">
        <div class="modal-box" style="max-width:700px; text-align:left;">
            <span class="close-modal" onclick="closeModal('resultModal')">&times;</span>
            <h3 id="resultTitle" style="color:var(--primary); margin-top:0;">Analiz Raporu</h3>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            
            <div id="typewriterArea" class="typewriter-text"></div>
            <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button id="storyBtn" class="btn-base btn-outline" onclick="downloadStory()" style="border-color:#e1306c; color:#e1306c;">
                <i class="fa-brands fa-instagram"></i> Story Paylaş
            </button>
    <button class="btn-base btn-outline" onclick="downloadPDF()"><i class="fa-solid fa-file-pdf"></i> PDF İndir</button>
    <button class="btn-base btn-outline" onclick="copyResult()"><i class="fa-regular fa-copy"></i> Kopyala</button>
    </div>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-box" style="max-width:600px; padding:0; overflow:hidden;">
            <div style="padding:20px; background:#1900ff; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Analizlerim</h3>
                <span style="cursor:pointer; font-size:1.5rem;" onclick="closeModal('historyModal')">&times;</span>
            </div>
            <div id="historyList" class="history-list"></div>
        </div>
    </div>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Giriş Yap</h2>
            <input type="email" id="loginEmail" class="auth-input" placeholder="E-posta">
            <input type="password" id="loginPass" class="auth-input" placeholder="Şifre">
            <button class="submit-btn" onclick="login()">Giriş Yap</button>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Kayıt Ol</h2>
            <input type="email" id="regEmail" class="auth-input" placeholder="E-posta">
            <input type="password" id="regPass" class="auth-input" placeholder="Şifre">
            <button class="submit-btn" onclick="register()">Kayıt Ol</button>
        </div>
    </div>

    <script>
        // --- GLOBAL DEĞİŞKENLER (Veri Yönetimi İçin) ---
        let currentUserAnalyses = []; // Analizleri burada tutacağız
        let typeInterval; // Daktilo efekti için
        // --- MÜZİK KONTROLÜ ---
        let musicPlaying = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            const music = document.getElementById('bgMusic');
            music.volume = 0.05; // SES SEVİYESİ (%20) - Rahatsız etmesin diye kısık
            
            // Kullanıcı sayfada herhangi bir yere tıkladığında müziği başlat
            document.body.addEventListener('click', function startMusic() {
                if (!musicPlaying) {
                    music.play().then(() => {
                        musicPlaying = true;
                        updateMusicIcon();
                    }).catch(e => console.log("Müzik başlatılamadı (Henüz etkileşim yok)"));
                    
                    // Olay dinleyiciyi kaldır (Tek seferlik çalışsın)
                    document.body.removeEventListener('click', startMusic);
                }
            });
        });

        function toggleMusic() {
            const music = document.getElementById('bgMusic');
            if (music.paused) {
                music.play();
                musicPlaying = true;
            } else {
                music.pause();
                musicPlaying = false;
            }
            updateMusicIcon();
        }

        function updateMusicIcon() {
            const icon = document.getElementById('musicIcon');
            const music = document.getElementById('bgMusic');
            if (!music.paused) {
                icon.className = "fa-solid fa-music";
                icon.style.color = "#a29bfe"; // Çalarken mor olsun
                // Döner animasyon ekleyelim
                icon.style.animation = "spin 4s linear infinite";
            } else {
                icon.className = "fa-solid fa-volume-xmark";
                icon.style.color = "white";
                icon.style.animation = "none";
            }
        }
        // --- SEÇİM MANTIĞI ---
        function selectOption(el, inputId, value) {
            const container = el.parentElement;
            container.querySelectorAll('.m-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById(inputId).value = value;
        }

        // --- PDF İNDİRME FONKSİYONU (YENİ) ---
        // --- YENİ VE GERÇEK PDF İNDİRME FONKSİYONU ---
        function downloadPDF() {
            // İndirilecek alanı seç
            const element = document.getElementById('typewriterArea');
            
            // PDF Ayarları
            const opt = {
                margin:       20,
                filename:     'Insan_Ekspertizi_Analiz_Raporu.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 }, // Yüksek çözünürlük için
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // PDF oluştur ve indir (Yazdırma ekranı açmaz)
            html2pdf().set(opt).from(element).save();
        }
        // --- INSTAGRAM STORY İNDİRME ---
        function downloadStory() {
            // 1. Analiz metnini al
            let fullText = document.getElementById('typewriterArea').innerText;
            
            // 2. Metni kısalt (Story'e sığması için ilk 350 karakter)
            // Eğer metin çok uzunsa sonuna "..." koyarız
            let shortText = fullText.length > 350 ? fullText.substring(0, 350) + "..." : fullText;

            // 3. Şablona yerleştir
            document.getElementById('storyText').innerText = '"' + shortText + '"';

            // 4. Kullanıcıya bilgi ver
            let originalBtnText = document.getElementById('storyBtn').innerHTML;
            document.getElementById('storyBtn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Hazırlanıyor...';

            // 5. Resmi Oluştur ve İndir
            const template = document.getElementById('storyTemplate');
            
            html2canvas(template, {scale: 1}).then(canvas => {
                let link = document.createElement('a');
                link.download = 'Insan_Ekspertizi_Story.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Butonu düzelt
                document.getElementById('storyBtn').innerHTML = originalBtnText;
            });
        }

        // --- İSTEK GÖNDERME ---
        async function submitRequest(type) {
            const token = localStorage.getItem("token");
            if(!token) return openModal('loginModal');

            // 1. BUTONU KİLİTLE
            let btn;
            let originalText;
            if(type === 'isim') {
                btn = document.querySelector('#member-tools .tool-card:nth-child(1) .submit-btn');
            } else {
                btn = document.querySelector('#member-tools .tool-card:nth-child(2) .submit-btn');
            }
            if(btn) {
                originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uzman İnceliyor...';
            }

            // Verileri Hazırla
            let fd = new FormData();
            let url = "";
            
            if(type === 'isim') {
                const isim = document.getElementById('isim').value;
                const soyisim = document.getElementById('soyisim').value;
                const mentor = document.getElementById('isim_mentor').value;
                if(!isim) { alert("İsim giriniz"); if(btn) {btn.disabled=false; btn.innerHTML=originalText;} return; }
                fd.append("isim", isim);
                fd.append("soyisim", soyisim);
                fd.append("mentor", mentor);
                url = "/api/isim-analizi-yap";
            } else {
                const ruya = document.getElementById('ruya-metni').value;
                const mentor = document.getElementById('ruya_mentor').value;
                if(!ruya) { alert("Rüya giriniz"); if(btn) {btn.disabled=false; btn.innerHTML=originalText;} return; }
                fd.append("ruya_metni", ruya);
                fd.append("mentor", mentor);
                url = "/api/ruya-analizi";
            }

            try {
                let res = await fetch(url, {method:"POST", headers:{"Authorization":`Bearer ${token}`}, body:fd});
                
                if(btn) { btn.disabled = false; btn.innerHTML = originalText; }

                if(res.ok) {
                    document.getElementById("successMsg").innerText = "Analiziniz tamamlandı! 'Analizlerim' menüsünden hemen okuyabilirsiniz.";
                    openModal('successModal');
                    if(document.getElementById('isim')) document.getElementById('isim').value = "";
                    if(document.getElementById('ruya-metni')) document.getElementById('ruya-metni').value = "";
                } else {
                    alert("Bir hata oluştu.");
                }
            } catch(e) {
                if(btn) { btn.disabled = false; btn.innerHTML = originalText; }
                alert("Bağlantı hatası.");
            }
        }

        // --- GEÇMİŞ VE DURUM KONTROLÜ (DÜZELTİLDİ) ---
        async function openHistory() {
            openModal('historyModal');
            const list = document.getElementById('historyList');
            list.innerHTML = '<p style="padding:20px; text-align:center;"><i class="fa-solid fa-spinner fa-spin"></i> Yükleniyor...</p>';
            
            try {
                const token = localStorage.getItem("token");
                const res = await fetch("/api/users/me", {headers:{"Authorization":`Bearer ${token}`}});
                if(!res.ok) { list.innerHTML = '<p style="color:red; text-align:center;">Veri alınamadı.</p>'; return; }

                const user = await res.json();
                
                // VERİLERİ GLOBALE KAYDET (Hata Çözümü)
                currentUserAnalyses = user.analyses || [];

                if(currentUserAnalyses.length === 0) {
                    list.innerHTML = '<p style="padding:20px; text-align:center;">Henüz analiz yok.</p>';
                    return;
                }

                list.innerHTML = "";
                
                // index parametresi ile döngü
                currentUserAnalyses.forEach((a, index) => {
                    // Tarih Düzeltme (UTC -> TR)
                    let tarihStr = "Tarih Yok";
                    if(a.created_at) {
                        let rawDate = a.created_at.endsWith("Z") ? a.created_at : a.created_at + "Z";
                        tarihStr = new Date(rawDate).toLocaleString('tr-TR', {
                            day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                        });
                    }

                    // BUTON: Artık metni değil, index numarasını gönderiyoruz
                    let btnHtml = `<button class="h-btn btn-view" onclick="openResultByIndex(${index})">Sonucu Oku</button>`;

                    list.innerHTML += `
                        <div class="h-item">
                            <div class="h-info">
                                <div style="font-weight:bold;">${a.analysis_type === 'ISIM' ? 'İsim Analizi' : 'Rüya Yorumu'}</div>
                                <div style="font-size:0.8rem; color:#888;">${a.input_text.substring(0,25)}...</div>
                                <div style="font-size:0.7rem; color:#aaa;">${tarihStr}</div>
                            </div>
                            <div style="text-align:right;">
                                <span class="h-status status-ready"><i class="fa-solid fa-check"></i> Hazır</span>
                                ${btnHtml}
                            </div>
                        </div>
                    `;
                });
            } catch(e) { list.innerHTML = "Hata oluştu."; }
        }

        // --- YENİ SONUÇ GÖSTERME FONKSİYONU ---
        function openResultByIndex(index) {
            const analiz = currentUserAnalyses[index];
            if(!analiz) return;

            closeModal('historyModal');
            openModal('resultModal');

            document.getElementById('resultTitle').innerText = 
                analiz.analysis_type === 'ISIM' ? 'İsim Karakter Analizi' : 'Rüya Tabiri Raporu';
            
            const text = analiz.result_text;
            const container = document.getElementById('typewriterArea');
            container.innerHTML = ""; 
            
            let i = 0;
            clearInterval(typeInterval);

            // Hızlı Daktilo Efekti
            typeInterval = setInterval(() => {
                container.innerHTML += text.charAt(i);
                container.scrollTop = container.scrollHeight;
                i++;
                if (i >= text.length) clearInterval(typeInterval);
            }, 10);
        }

        function copyResult() {
            const text = document.getElementById('typewriterArea').innerText;
            navigator.clipboard.writeText(text);
            alert("Kopyalandı!");
        }

        // --- AUTH & GENEL ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; clearInterval(typeInterval); }
        
        if(localStorage.getItem("token")) {
            document.getElementById("guest-nav").style.display = "none";
            document.getElementById("user-nav").style.display = "flex";
            document.getElementById("guest-hero").style.display = "none";
            document.getElementById("member-tools").style.display = "grid";
        }

        async function login() {
            const email = document.getElementById("loginEmail").value;
            const pass = document.getElementById("loginPass").value;
            let fd = new FormData(); fd.append("username", email); fd.append("password", pass);
            
            try {
                let res = await fetch("/api/token", {method:"POST", body:fd});
                if(res.ok) {
                    let data = await res.json();
                    localStorage.setItem("token", data.access_token);
                    window.location.reload();
                } else {
                    let errorData = await res.json();
                    alert("Giriş Yapılamadı: " + (errorData.detail || "Hata"));
                }
            } catch(e) { alert("Bağlantı hatası."); }
        }

        async function register() {
            let email = document.getElementById("regEmail").value;
            let pass = document.getElementById("regPass").value;
            try {
                let res = await fetch("/api/register", {
                    method:"POST", 
                    headers:{"Content-Type":"application/json"}, 
                    body:JSON.stringify({email, password:pass})
                });
                if(res.ok) { 
                    alert("Kayıt Başarılı! Giriş yapabilirsiniz."); 
                    closeModal('registerModal');
                    openModal('loginModal');
                } else {
                    let errorData = await res.json();
                    alert("Kayıt Başarısız: " + (errorData.detail || "Hata"));
                }
            } catch(e) { alert("Bağlantı hatası."); }
        }

        function logout() { localStorage.removeItem("token"); window.location.reload(); }
    </script>
    <div id="storyTemplate" style="
        position: fixed; left: -9999px; top: 0; 
        width: 1080px; height: 1920px; 
        background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); 
        font-family: 'Poppins', sans-serif; color: white; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        padding: 100px; box-sizing: border-box; z-index: 99999;">
        
        <div style="font-size: 70px; font-weight: 800; color: #a29bfe; margin-bottom: 120px; display: flex; align-items: center; gap: 30px;">
            <i class="fa-solid fa-moon"></i> İnsan Ekspertizi
        </div>

        <div style="
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(40px); 
            padding: 80px; 
            border-radius: 60px; 
            border: 4px solid rgba(162, 155, 254, 0.3); 
            width: 100%; 
            box-shadow: 0 40px 100px rgba(0,0,0,0.5);
            text-align: center;">
            
            <h2 style="font-size: 55px; color: #a29bfe; margin-bottom: 50px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 30px;">
                Kişiye Özel Ruhsal Analiz
            </h2>
            
            <p id="storyText" style="font-size: 45px; line-height: 1.6; color: #ffffff; font-weight: 500;">
                </p>
            
            <div style="margin-top: 50px; font-size: 35px; color: #b2bec3;">
                <i class="fa-solid fa-quote-right"></i>
            </div>
        </div>

        <div style="margin-top: auto; text-align: center;">
            <div style="font-size: 40px; color: #fff; font-weight: bold; margin-bottom: 20px;">Senin Rüyaların Ne Söylüyor?</div>
            <div style="background: white; color: #0f0c29; padding: 15px 40px; border-radius: 50px; font-size: 35px; font-weight: 800; display: inline-block;">
                insanekspertizi.org
            </div>
        </div>
    </div>
</body>
</html>