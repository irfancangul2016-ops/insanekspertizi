<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetici Paneli | İnsan Ekspertizi</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9626/9626780.png">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #e2e8f0;
            --primary: #38bdf8;
            --accent: #f472b6;
            --success: #22c55e;
            --danger: #ef4444;
            --border: #334155;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'JetBrains Mono', monospace; /* Kod havası */
            margin: 0; padding: 20px;
        }
        
        /* HEADER & NAV */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 30px;
        }
        .nav-tabs { display: flex; gap: 10px; }
        .nav-btn {
            background: transparent; border: 1px solid var(--border); color: #94a3b8;
            padding: 10px 20px; cursor: pointer; border-radius: 8px; font-family: inherit;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .nav-btn:hover { background: var(--border); color: white; }
        .nav-btn.active { background: var(--primary); color: #0f172a; border-color: var(--primary); font-weight: bold; }

        /* ORTAK */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        /* KUTULAR (STATS) */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;
        }
        .stat-card {
            background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-num { font-size: 2.5rem; font-weight: bold; margin: 10px 0; color: var(--accent); }
        .stat-label { color: #94a3b8; font-size: 0.9rem; }

        /* TABLO */
        .table-container {
            background: var(--card); border-radius: 10px; overflow: hidden; border: 1px solid var(--border);
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { background: var(--border); color: var(--primary); }
        tr:hover { background: #2d3e52; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-ISIM { background: rgba(56, 189, 248, 0.2); color: var(--primary); }
        .badge-RUYA { background: rgba(244, 114, 182, 0.2); color: var(--accent); }

        /* BLOG YAZARI (YENİ) */
        .editor-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        @media (max-width: 900px) { .editor-grid { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; color: #94a3b8; margin-bottom: 8px; font-size: 0.9rem; }
        input, textarea {
            width: 100%; background: #020617; border: 1px solid var(--border); color: white;
            padding: 15px; border-radius: 8px; font-family: 'Poppins', sans-serif; /* Yazarken rahat olsun */
            box-sizing: border-box; font-size: 1rem; transition: border-color 0.3s;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); }
        textarea { height: 400px; resize: vertical; line-height: 1.6; }

        .btn {
            background: var(--success); color: white; border: none; padding: 12px 24px;
            cursor: pointer; border-radius: 8px; font-weight: bold; font-family: inherit;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); padding: 5px 10px; font-size: 0.8rem; }
        
        /* Blog Listesi (Admin) */
        .post-item {
            background: #020617; border: 1px solid var(--border); padding: 15px; border-radius: 8px;
            margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .post-title { font-weight: bold; color: var(--text); }
        .post-meta { font-size: 0.8rem; color: #64748b; margin-top: 4px; }

    </style>
</head>
<body>

    <div class="header">
        <h1 style="color:var(--primary); margin:0;">
            <i class="fa-solid fa-terminal"></i> YÖNETİCİ KOKPİTİ
        </h1>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('dashboard')" id="btn-dash">
                <i class="fa-solid fa-chart-line"></i> İstatistikler
            </button>
            <button class="nav-btn" onclick="switchTab('blog')" id="btn-blog">
                <i class="fa-solid fa-pen-nib"></i> Blog Yazarı
            </button>
            <button class="nav-btn" onclick="logout()" style="border-color:var(--danger); color:var(--danger)">
                <i class="fa-solid fa-power-off"></i> Çıkış
            </button>
        </div>
    </div>

    <div id="loading" style="text-align: center; margin-top: 50px;">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
    </div>

    <div id="dashboard-sec" class="section">
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fa-solid fa-users fa-lg"></i>
                <span class="stat-num" id="totalUsers">-</span>
                <span class="stat-label">TOPLAM ÜYE</span>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-wand-magic-sparkles fa-lg"></i>
                <span class="stat-num" id="totalAnalysis">-</span>
                <span class="stat-label">TOPLAM ANALİZ</span>
            </div>
            <div class="stat-card">
                <i class="fa-solid fa-newspaper fa-lg"></i>
                <span class="stat-num" id="totalPosts" style="color:#fbbf24">-</span>
                <span class="stat-label">YAYINDAKİ YAZI</span>
            </div>
        </div>

        <div class="table-container">
            <div style="padding:20px; background:var(--border); font-weight:bold; color:var(--primary);">CANLI ANALİZ AKIŞI (Son 50)</div>
            <table>
                <thead>
                    <tr><th>ID</th><th>KULLANICI</th><th>TÜR</th><th>GİRDİ</th><th>ZAMAN</th></tr>
                </thead>
                <tbody id="activityTable"></tbody>
            </table>
        </div>
    </div>

    <div id="blog-sec" class="section">
        <div class="editor-grid">
            
            <div>
                <h2 style="margin-top:0; color:var(--primary)">Yeni Makale Yaz</h2>
                <div class="form-group">
                    <label>Başlık</label>
                    <input type="text" id="blogTitle" placeholder="Örn: Rüyada Diş Kırılması Ne Anlama Gelir?">
                </div>
                <div class="form-group">
                    <label>Kapak Resmi URL (Unsplash vb.)</label>
                    <input type="text" id="blogImage" placeholder="https://images.unsplash.com/...">
                    <small style="color:#64748b">Öneri: Unsplash.com'dan resim linki kopyalayıp yapıştır.</small>
                </div>
                <div class="form-group">
                    <label>İçerik (Makale Metni)</label>
                    <textarea id="blogContent" placeholder="Makale içeriğini buraya yazın... Paragraf yapmak için Enter'a basın."></textarea>
                </div>
                <button class="btn" onclick="publishPost()">
                    <i class="fa-solid fa-paper-plane"></i> YAYINLA
                </button>
            </div>

            <div>
                <h2 style="margin-top:0; color:#fbbf24">Yayındaki Yazılar</h2>
                <div id="postsList">
                    </div>
            </div>

        </div>
    </div>

    <script>
        const BASE_URL = "/api";
        let TOKEN = localStorage.getItem("token");

        // --- BAŞLANGIÇ ---
        async function init() {
            if (!TOKEN) { alert("Giriş yapmalısın!"); window.location.href="/"; return; }
            
            // İlk açılışta verileri çek
            await loadStats();
            await loadPosts();
            
            document.getElementById("loading").style.display = "none";
            document.getElementById("dashboard-sec").classList.add("active");
        }

        // --- SEKME GEÇİŞLERİ ---
        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

            if (tab === 'dashboard') {
                document.getElementById('dashboard-sec').classList.add('active');
                document.getElementById('btn-dash').classList.add('active');
                // Dashboard açılınca istatistikleri yenile
                loadStats();
            } else {
                document.getElementById('blog-sec').classList.add('active');
                document.getElementById('btn-blog').classList.add('active');
                // Blog sekmesi açılınca listeyi yenile
                loadPosts();
            }
        }

        // --- DATA: ISTATISTIKLER ---
        async function loadStats() {
            try {
                const res = await fetch(`${BASE_URL}/admin/stats`, { headers: { "Authorization": `Bearer ${TOKEN}` } });
                if (res.status === 403) { document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:50px'>YETKİSİZ ALAN</h1>"; return; }
                
                const data = await res.json();
                document.getElementById("totalUsers").innerText = data.total_users;
                document.getElementById("totalAnalysis").innerText = data.total_analysis;
                document.getElementById("totalPosts").innerText = data.total_posts || 0;

                const tbody = document.getElementById("activityTable");
                tbody.innerHTML = "";
                data.activities.forEach(item => {
                    const badgeClass = item.type === "ISIM" ? "badge-ISIM" : "badge-RUYA";
                    tbody.innerHTML += `
                        <tr>
                            <td style="color:#64748b">#${item.id}</td>
                            <td>${item.user}</td>
                            <td><span class="badge ${badgeClass}">${item.type}</span></td>
                            <td style="color:#cbd5e1">${item.input}</td>
                            <td style="color:#94a3b8">${item.date}</td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        // --- DATA: BLOG YAZILARI ---
        async function loadPosts() {
            const list = document.getElementById("postsList");
            list.innerHTML = "<small>Yükleniyor...</small>";
            try {
                const res = await fetch(`${BASE_URL}/blog/posts`);
                const posts = await res.json();
                
                list.innerHTML = "";
                if(posts.length === 0) { list.innerHTML = "<small style='color:#64748b'>Henüz yazı yok.</small>"; return; }

                posts.forEach(p => {
                    list.innerHTML += `
                        <div class="post-item">
                            <div>
                                <div class="post-title">${p.title}</div>
                                <div class="post-meta"><i class="fa-solid fa-eye"></i> ${p.views} • ${new Date(p.created_at).toLocaleDateString()}</div>
                            </div>
                            <button class="btn btn-danger" onclick="deletePost(${p.id})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                });
            } catch (e) { list.innerHTML = "Hata."; }
        }

        // --- ACTION: YAZI YAYINLA ---
        async function publishPost() {
            const title = document.getElementById("blogTitle").value;
            const content = document.getElementById("blogContent").value;
            const image = document.getElementById("blogImage").value;

            if(!title || !content || !image) { alert("Lütfen tüm alanları doldur!"); return; }

            if(!confirm("Bu yazıyı yayınlamak istiyor musun?")) return;

            const fd = new FormData();
            fd.append("title", title);
            fd.append("content", content);
            fd.append("image_url", image);

            try {
                const res = await fetch(`${BASE_URL}/admin/blog/create`, {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${TOKEN}` },
                    body: fd
                });
                if(res.ok) {
                    alert("✅ Yazı başarıyla yayınlandı!");
                    document.getElementById("blogTitle").value = "";
                    document.getElementById("blogContent").value = "";
                    document.getElementById("blogImage").value = "";
                    loadPosts();
                    loadStats();
                } else {
                    const errData = await res.json();
                    alert("HATA: " + (errData.detail || "Bilinmeyen bir sorun var."));
                }
            } catch(e) { alert("Sunucu hatası: " + e); }
        }

        // --- ACTION: YAZI SİL ---
        async function deletePost(id) {
            if(!confirm("Bu yazıyı kalıcı olarak silmek istediğine emin misin?")) return;
            
            try {
                const res = await fetch(`${BASE_URL}/admin/blog/delete/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${TOKEN}` }
                });
                if(res.ok) { loadPosts(); loadStats(); }
            } catch(e) { alert("Silinemedi."); }
        }

        function logout() { localStorage.removeItem("token"); window.location.href="/"; }

        init();
    </script>
</body>
</html>